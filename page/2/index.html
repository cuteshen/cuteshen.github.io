<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Mrshen, nodejs" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="彩笔前端爬坑历程">
<meta property="og:type" content="website">
<meta property="og:title" content="Mr.Shen">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Mr.Shen">
<meta property="og:description" content="彩笔前端爬坑历程">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mr.Shen">
<meta name="twitter:description" content="彩笔前端爬坑历程">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/2/"/>

  <title> Mr.Shen </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1431c9fab2d4da96c2122f2351783e32";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mr.Shen</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/10/构建工具——webpack/" itemprop="url">
                  构建工具——webpack
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-10T18:58:08+08:00" content="2016-09-10">
              2016-09-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/10/构建工具——webpack/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/10/构建工具——webpack/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="安装webpack"><a href="#安装webpack" class="headerlink" title="安装webpack"></a>安装webpack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install webpack -g</div></pre></td></tr></table></figure>
<p>当然如果常规项目还是把依赖写入 package.json 包去更人性化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm init</div><div class="line"></div><div class="line">npm install webpack --save-dev</div></pre></td></tr></table></figure>
<h2 id="添加第三方模块"><a href="#添加第三方模块" class="headerlink" title="添加第三方模块"></a>添加第三方模块</h2><p>package.json:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&quot;devDependencies&quot;: &#123;</div><div class="line">  &quot;autoprefixer-loader&quot;: &quot;^3.2.0&quot;,</div><div class="line">  &quot;babel-core&quot;: &quot;^6.14.0&quot;,</div><div class="line">  &quot;babel-loader&quot;: &quot;^6.2.5&quot;,</div><div class="line">  &quot;babel-plugin-transform-runtime&quot;: &quot;^6.15.0&quot;,</div><div class="line">  &quot;babel-preset-es2015&quot;: &quot;^6.14.0&quot;,</div><div class="line">  &quot;babel-runtime&quot;: &quot;^6.11.6&quot;,</div><div class="line">  &quot;css-loader&quot;: &quot;^0.25.0&quot;,</div><div class="line">  &quot;file-loader&quot;: &quot;^0.9.0&quot;,</div><div class="line">  &quot;html-loader&quot;: &quot;^0.4.3&quot;,</div><div class="line">  &quot;node-sass&quot;: &quot;^3.9.3&quot;,</div><div class="line">  &quot;sass-loader&quot;: &quot;^4.0.2&quot;,</div><div class="line">  &quot;style-loader&quot;: &quot;^0.13.1&quot;,</div><div class="line">  &quot;url-loader&quot;: &quot;^0.5.7&quot;,</div><div class="line">  &quot;vue-hot-reload-api&quot;: &quot;^1.3.3&quot;,</div><div class="line">  &quot;vue-html-loader&quot;: &quot;^1.2.3&quot;,</div><div class="line">  &quot;vue-loader&quot;: &quot;^8.5.2&quot;,</div><div class="line">  &quot;vue-router&quot;: &quot;^0.7.13&quot;,</div><div class="line">  &quot;vue-style-loader&quot;: &quot;^1.0.0&quot;,</div><div class="line">  &quot;webpack&quot;: &quot;^1.13.2&quot;,</div><div class="line">  &quot;webpack-dev-server&quot;: &quot;^1.15.1&quot;</div><div class="line">&#125;,</div><div class="line">&quot;dependencies&quot;: &#123;</div><div class="line">  &quot;vue&quot;: &quot;^1.0.26&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src="/img/webpack.png" alt="img"></p>
<h2 id="编写webpack-config-js"><a href="#编写webpack-config-js" class="headerlink" title="编写webpack.config.js"></a>编写webpack.config.js</h2><p>每个项目下都必须配置有一个 webpack.config.js ，它的作用如同常规的 gulpfile.js/Gruntfile.js 一样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">var Webpack = require(&quot;webpack&quot;);</div><div class="line">var path = require(&apos;path&apos;);</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">    //入口文件配置也可以是数组</div><div class="line">    entry: &apos;./src/main.js&apos;,</div><div class="line">    //输出项配置</div><div class="line">    output: &#123;</div><div class="line">            path: path.join(__dirname, &apos;./dist&apos;),</div><div class="line">            // 文件地址，使用绝对路径形式</div><div class="line">            filename: &apos;[name].js&apos;,</div><div class="line">            //[name]这里是webpack提供的根据路口文件自动生成的名字</div><div class="line">            publicPath: &apos;/dist/&apos;</div><div class="line">            // 公共文件生成的地址</div><div class="line">        &#125;,</div><div class="line">    // 服务器配置相关，自动刷新!</div><div class="line">    devServer: &#123;</div><div class="line">        historyApiFallback: true,</div><div class="line">        hot: false,</div><div class="line">        inline: true,</div><div class="line">        grogress: true,</div><div class="line">    &#125;,</div><div class="line">    //加载器配置,告知 webpack 每一种文件都需要使用什么加载器来处理：</div><div class="line">    module: &#123;</div><div class="line">        loaders: [</div><div class="line">            // 解析.vue文件</div><div class="line">            &#123; test: /\.vue$/, loader: &apos;vue&apos; &#125;,</div><div class="line">            // 转化ES6的语法</div><div class="line">            &#123; test: /\.js$/, loader: &apos;babel&apos;, exclude: /node_modules/ &#125;,</div><div class="line">            // 编译css并自动添加css前缀</div><div class="line">            &#123; test: /\.css$/, loader: &apos;style!css!autoprefixer&apos;&#125;,</div><div class="line">            //.scss 文件想要编译，scss就需要这些东西！来编译处理</div><div class="line">            //install css-loader style-loader sass-loader node-sass --save-dev</div><div class="line">            &#123; test: /\.scss$/, loader: &apos;style!css!sass?sourceMap&apos;&#125;,</div><div class="line">            //limit小于16k的图片转换成base64格式</div><div class="line">            &#123; test: /\.(png|jpg|gif)$/, loader: &apos;url-loader?limit=16000&apos;&#125;,</div><div class="line">            //html模板编译？</div><div class="line">            &#123; test: /\.(html|tpl)$/, loader: &apos;html-loader&apos; &#125;,</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    // .vue的配置。需要单独出来配置，其实没什么必要--因为我删了也没保错，不过这里就留这把，因为官网文档里是可以有单独的配置的。</div><div class="line">    vue: &#123;</div><div class="line">        loaders: &#123;</div><div class="line">            css: &apos;style!css!autoprefixer&apos;,</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    resolve: &#123;</div><div class="line">        // require时省略的扩展名，如：require(&apos;module&apos;) 不需要module.js</div><div class="line">        extensions: [&apos;&apos;, &apos;.js&apos;, &apos;.vue&apos;],</div><div class="line">        // 别名，可以直接使用别名来代表设定的路径以及其他</div><div class="line">        alias: &#123;</div><div class="line">            filter: path.join(__dirname, &apos;./src/filters&apos;),</div><div class="line">            components: path.join(__dirname, &apos;./src/components&apos;)</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    //插件配置</div><div class="line">    plugins: [</div><div class="line">        new Webpack.BannerPlugin(&quot;这里是打包文件头部注释！&quot;)//注意这是一个数组..</div><div class="line">    ],</div><div class="line">    //采用source-map的形式直接显示你出错代码的位置</div><div class="line">    devtool: &apos;eval-source-map&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="新建html"><a href="#新建html" class="headerlink" title="新建html"></a>新建html</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head lang=&quot;en&quot;&gt;</div><div class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div><div class="line">    &lt;title&gt;&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;div id=&quot;app&quot;&gt;</div><div class="line">    &lt;router-view&gt;&lt;/router-view&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;!--引入webpack编译后的输出文件main.js--&gt;</div><div class="line">&lt;script src=&quot;dist/main.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h2 id="package-json配置命令"><a href="#package-json配置命令" class="headerlink" title="package.json配置命令"></a>package.json配置命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;scripts&quot;: &#123;</div><div class="line">    &quot;start&quot;: &quot;webpack-dev-server --inline&quot;</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<p>执行webpack执行构建</p>
<p>webpack –config XXX.js   //通过文件名执行（比如webpack.config2.js）来打包</p>
<p>webpack –watch   //监听变动并自动打包</p>
<p>webpack -p    //压缩混淆脚本，这个非常非常重要！</p>
<p>webpack -d    //生成map映射文件，告知哪些模块被最终打包到哪里了</p>
<h4 id="也可以通过执行npm-run-start执行构建并监听"><a href="#也可以通过执行npm-run-start执行构建并监听" class="headerlink" title="也可以通过执行npm run start执行构建并监听"></a>也可以通过执行npm run start执行构建并监听</h4><p>另外webpack-dev-server监听需要访问localhost:8080/webpack-dev-server浏览器才会自动刷新</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/03/NodeJs——数据库操作，登录，注册/" itemprop="url">
                  NodeJs——数据库操作，登录，注册
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-03T21:42:31+08:00" content="2016-09-03">
              2016-09-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/03/NodeJs——数据库操作，登录，注册/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/03/NodeJs——数据库操作，登录，注册/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var db=mysql.createConnection(&#123;</div><div class="line">    host:       &apos;localhost&apos;,</div><div class="line">    user:       &apos;root&apos;,</div><div class="line">    password:   &apos;xxxx&apos;,</div><div class="line">    database:   &apos;数据库名称&apos;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">db.query(sql,function(err,data)&#123;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="MD5加密模块"><a href="#MD5加密模块" class="headerlink" title="MD5加密模块"></a>MD5加密模块</h2><h3 id="为了方便使用，提前写成node模块"><a href="#为了方便使用，提前写成node模块" class="headerlink" title="为了方便使用，提前写成node模块:"></a>为了方便使用，提前写成node模块:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//引入node加密模块crypto</div><div class="line">const crypto=require(&apos;crypto&apos;);</div><div class="line">//定义加密方法</div><div class="line">function md5(str)&#123;</div><div class="line">    //设置为md5加密</div><div class="line">    var obj=crypto.createHash(&apos;md5&apos;);</div><div class="line">    //带入参数</div><div class="line">    obj.update(str);</div><div class="line">    //以16进制进行加密</div><div class="line">    return obj.digest(&apos;hex&apos;);</div><div class="line">&#125;</div><div class="line">//暴露出去</div><div class="line">exports.md5=md5;</div></pre></td></tr></table></figure>
<h3 id="调用方式："><a href="#调用方式：" class="headerlink" title="调用方式："></a>调用方式：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">const md5=require(&apos;./md5&apos;).md5;</div><div class="line"></div><div class="line">console.log(md5(&apos;1234567&apos;));</div></pre></td></tr></table></figure>
<h2 id="前端代码-angular-http方法"><a href="#前端代码-angular-http方法" class="headerlink" title="前端代码-angular $http方法"></a>前端代码-angular $http方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head lang=&quot;en&quot;&gt;</div><div class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div><div class="line">    &lt;title&gt;&lt;/title&gt;</div><div class="line">    &lt;script src=&quot;js/angular.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">        var app=angular.module(&apos;app&apos;,[]);</div><div class="line">        app.controller(&apos;login-register&apos;, function ($scope, $http) &#123;</div><div class="line">            $scope.reg= function () &#123;</div><div class="line">                console.log(&apos;1&apos;)</div><div class="line">                $http.get(&apos;user&apos;,&#123;</div><div class="line">                    params:&#123;act:&apos;add&apos;,username:$scope.username,password:$scope.password&#125;</div><div class="line">                &#125;).success(function (res) &#123;</div><div class="line">                    console.log(2);</div><div class="line">                    alert(JSON.stringify(res));</div><div class="line">                &#125;).error(function(err)&#123;</div><div class="line">                    console.log(err);</div><div class="line">                &#125;)</div><div class="line">            &#125;;</div><div class="line"></div><div class="line">            $scope.login= function () &#123;</div><div class="line">                $http.get(&apos;user&apos;,&#123;</div><div class="line">                    params:&#123;act:&apos;login&apos;,username:$scope.username,password:$scope.password&#125;</div><div class="line">                &#125;).success(function (res) &#123;</div><div class="line">                    alert(JSON.stringify(res.msg));</div><div class="line">                &#125;).error(function(err)&#123;</div><div class="line">                    console.log(err);</div><div class="line">                &#125;)</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line"></div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body ng-app=&quot;app&quot;&gt;</div><div class="line">&lt;div ng-controller=&quot;login-register&quot;&gt;</div><div class="line">    user:</div><div class="line">    &lt;input type=&quot;text&quot; ng-model=&quot;username&quot;&gt;</div><div class="line">    &lt;br&gt;</div><div class="line">    pass:</div><div class="line">    &lt;input type=&quot;password&quot; ng-model=&quot;password&quot;&gt;</div><div class="line">    &lt;br&gt;</div><div class="line">    &lt;input type=&quot;button&quot; value=&quot;注册&quot; ng-click=&quot;reg()&quot;&gt;</div><div class="line">    &lt;input type=&quot;button&quot; value=&quot;登录&quot; ng-click=&quot;login()&quot;&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h2 id="主要业务实现"><a href="#主要业务实现" class="headerlink" title="主要业务实现"></a>主要业务实现</h2><h3 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">E.on(&apos;/user&apos;, function (req, res) &#123;</div><div class="line">    //链接数据库</div><div class="line">    var db=mysql.createConnection(&#123;</div><div class="line">        host:       &apos;localhost&apos;,</div><div class="line">        user:       &apos;root&apos;,</div><div class="line">        password:   &apos;root&apos;,</div><div class="line">        database:   &apos;user&apos;</div><div class="line">    &#125;)</div><div class="line">    //处理具体业务</div><div class="line">    var act=req.get.act;</div><div class="line">    console.log(req.get.act);</div><div class="line">    switch (act)&#123;</div><div class="line">        case &apos;add&apos;:</div><div class="line">            //注册</div><div class="line">            E.emit(&apos;add-user&apos;,req,res,db);</div><div class="line">            break;</div><div class="line">        case &apos;login&apos;:</div><div class="line">            //登录</div><div class="line">            E.emit(&apos;login-user&apos;,req,res,db);</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="注册方法"><a href="#注册方法" class="headerlink" title="注册方法"></a>注册方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">E.on(&apos;add-user&apos;, function (req, res, db) &#123;</div><div class="line">    var username=req.get.username;</div><div class="line">    var password=req.get.password;</div><div class="line"></div><div class="line">    var sql=`SELECT username FROM users WHERE username=&quot;$&#123;username&#125;&quot;`;</div><div class="line">    db.query(sql, function (err, data) &#123;</div><div class="line">        if(err)&#123;</div><div class="line">            res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库出问题&quot;&#125;));</div><div class="line">        &#125;else&#123;</div><div class="line">            if(data.length)&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1,msg:&quot;此用户名已存在&quot;&#125;));</div><div class="line">            &#125;else&#123;</div><div class="line">                var I_SQL=`INSERT INTO users VALUES(null,&quot;$&#123;username&#125;&quot;,&quot;$&#123;md5(md5(password))&#125;&quot;)`;</div><div class="line">                db.query(I_SQL, function (err, data) &#123;</div><div class="line">                    if(err)&#123;</div><div class="line">                        res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库方面的问题&quot;&#125;));</div><div class="line">                    &#125;else&#123;</div><div class="line">                        res.end(JSON.stringify(&#123;err:0,msg:&quot;注册成功&quot;&#125;));</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="登录方法"><a href="#登录方法" class="headerlink" title="登录方法"></a>登录方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">E.on(&apos;login-user&apos;, function (req, res, db) &#123;</div><div class="line">    var username=req.get.username;</div><div class="line">    var password=req.get.password;</div><div class="line"></div><div class="line">    var SQL=`SELECT * From users WHERE username=&quot;$&#123;username&#125;&quot;`;</div><div class="line">    db.query(SQL, function (err, data) &#123;</div><div class="line">        if(err)&#123;</div><div class="line">            res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库方面的问题&quot;&#125;));</div><div class="line">        &#125;else&#123;</div><div class="line">            if(data.length)&#123;</div><div class="line">                if(data[0].password == md5(md5(password)))&#123;</div><div class="line">                    res.end(JSON.stringify(&#123;err:0,msg:&quot;登录成功&quot;&#125;));</div><div class="line">                &#125;else&#123;</div><div class="line">                    res.end(JSON.stringify(&#123;err:1,msg:&quot;密码错误&quot;&#125;));</div><div class="line">                &#125;</div><div class="line">            &#125;else&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1,msg:&quot;此用户不存在&quot;&#125;));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>完整项目地址：原来github还按项目收费，好吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line">const http = require(&apos;http&apos;);</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line">const os = require(&apos;os&apos;);</div><div class="line">const cluster = require(&apos;cluster&apos;);</div><div class="line">const EventEmitter = require(&apos;events&apos;).EventEmitter;</div><div class="line">const mysql=require(&apos;mysql&apos;)</div><div class="line">const urlLib=require(&apos;url&apos;);</div><div class="line">var cpus=os.cpus().length;</div><div class="line"></div><div class="line">if(cluster.isMaster)&#123;</div><div class="line">    for(var i=1; i&lt;cpus; i++)&#123;</div><div class="line">        cluster.fork();</div><div class="line">    &#125;</div><div class="line">    cluster.on(&apos;exit&apos;, function (worker, code, signal) &#123;</div><div class="line">        cluster.fork();</div><div class="line">    &#125;)</div><div class="line">&#125;else&#123;</div><div class="line">    var E=new EventEmitter();</div><div class="line"></div><div class="line">    http.createServer(function (req, res) &#123;</div><div class="line">        E.emit(&apos;get-parse&apos;,req,res);</div><div class="line">    &#125;).listen(8080);</div><div class="line">    E.on(&apos;get-parse&apos;, function (req, res) &#123;</div><div class="line">        req.get=urlLib.parse(req.url,true).query;</div><div class="line">        req.url=urlLib.parse(req.url,true).pathname;</div><div class="line"></div><div class="line">        E.emit(&apos;buss-do&apos;,req,res);</div><div class="line">    &#125;)</div><div class="line">    E.on(&apos;buss-do&apos;, function (req, res) &#123;</div><div class="line">        var bool=E.emit(req.url,req,res);</div><div class="line">        if(bool == false)&#123;</div><div class="line">            E.emit(&apos;read-file&apos;,req,res);</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    E.on(&apos;read-file&apos;, function (req, res) &#123;</div><div class="line"></div><div class="line">        var rs=fs.createReadStream(&apos;www&apos;+req.url);</div><div class="line">        rs.pipe(res);</div><div class="line">        rs.on(&apos;error&apos;, function () &#123;</div><div class="line">            res.writeHeader(404);</div><div class="line">            res.write(&apos;404&apos;);</div><div class="line">            res.end();</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line">    //以下处理接口</div><div class="line">    E.on(&apos;/user&apos;, function (req, res) &#123;</div><div class="line">        //链接数据库</div><div class="line">        var db=mysql.createConnection(&#123;</div><div class="line">            host:       &apos;localhost&apos;,</div><div class="line">            user:       &apos;root&apos;,</div><div class="line">            password:   &apos;root&apos;,</div><div class="line">            database:   &apos;user&apos;</div><div class="line">        &#125;)</div><div class="line">        //处理具体业务</div><div class="line">        var act=req.get.act;</div><div class="line">        console.log(req.get.act);</div><div class="line">        switch (act)&#123;</div><div class="line">            case &apos;add&apos;:</div><div class="line">                E.emit(&apos;add-user&apos;,req,res,db);</div><div class="line">                break;</div><div class="line">            case &apos;login&apos;:</div><div class="line">                E.emit(&apos;login-user&apos;,req,res,db);</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    //注册</div><div class="line">    E.on(&apos;add-user&apos;, function (req, res, db) &#123;</div><div class="line">        var username=req.get.username;</div><div class="line">        var password=req.get.password;</div><div class="line"></div><div class="line">        var sql=`SELECT username FROM users WHERE username=&quot;$&#123;username&#125;&quot;`;</div><div class="line">        db.query(sql, function (err, data) &#123;</div><div class="line">            if(err)&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库方面的问题&quot;&#125;));</div><div class="line">            &#125;else&#123;</div><div class="line">                if(data.length)&#123;</div><div class="line">                    res.end(JSON.stringify(&#123;err:1,msg:&quot;此用户名已存在&quot;&#125;));</div><div class="line">                &#125;else&#123;</div><div class="line">                    var I_SQL=`INSERT INTO users VALUES(null,&quot;$&#123;username&#125;&quot;,&quot;$&#123;md5(md5(password))&#125;&quot;)`;</div><div class="line">                    db.query(I_SQL, function (err, data) &#123;</div><div class="line">                        if(err)&#123;</div><div class="line">                            res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库方面的问题&quot;&#125;));</div><div class="line">                        &#125;else&#123;</div><div class="line">                            res.end(JSON.stringify(&#123;err:0,msg:&quot;注册成功&quot;&#125;));</div><div class="line">                        &#125;</div><div class="line">                    &#125;)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    //登录</div><div class="line">    E.on(&apos;login-user&apos;, function (req, res, db) &#123;</div><div class="line">        var username=req.get.username;</div><div class="line">        var password=req.get.password;</div><div class="line"></div><div class="line">        var SQL=`SELECT * From users WHERE username=&quot;$&#123;username&#125;&quot;`;</div><div class="line">        db.query(SQL, function (err, data) &#123;</div><div class="line">            if(err)&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1,msg:&quot;数据库方面的问题&quot;&#125;));</div><div class="line">            &#125;else&#123;</div><div class="line">                if(data.length)&#123;</div><div class="line">                    if(data[0].password == md5(md5(password)))&#123;</div><div class="line">                        res.end(JSON.stringify(&#123;err:0,msg:&quot;登录成功&quot;&#125;));</div><div class="line">                    &#125;else&#123;</div><div class="line">                        res.end(JSON.stringify(&#123;err:1,msg:&quot;密码错误&quot;&#125;));</div><div class="line">                    &#125;</div><div class="line">                &#125;else&#123;</div><div class="line">                    res.end(JSON.stringify(&#123;err:1,msg:&quot;此用户不存在&quot;&#125;));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line"></div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/03/NodeJs——数据库操作mysql/" itemprop="url">
                  NodeJs——数据库操作mysql
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-03T21:41:39+08:00" content="2016-09-03">
              2016-09-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/03/NodeJs——数据库操作mysql/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/03/NodeJs——数据库操作mysql/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="nodeJs中mysql的使用"><a href="#nodeJs中mysql的使用" class="headerlink" title="nodeJs中mysql的使用"></a>nodeJs中mysql的使用</h2><p>首先安装mysql模块</p>
<pre><code>npm install mysql
</code></pre><p>node连接数据库方法</p>
<pre><code>var db=mysql.createConnection({
    host:       &apos;localhost&apos;,
    user:       &apos;root&apos;,
    password:   &apos;xxxx&apos;,
    database:   &apos;数据库名称&apos;
})
</code></pre><p>编写sql</p>
<pre><code>db.query(sql,function(err,data){

})
</code></pre><h3 id="实现数据库添加，查询"><a href="#实现数据库添加，查询" class="headerlink" title="实现数据库添加，查询"></a>实现数据库添加，查询</h3><h4 id="HTML代码"><a href="#HTML代码" class="headerlink" title="HTML代码"></a>HTML代码</h4><h5 id="add-news-html"><a href="#add-news-html" class="headerlink" title="add_news.html"></a>add_news.html</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;js/angular.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script&gt;</div><div class="line">        var app=angular.module(&apos;app&apos;,[]);</div><div class="line"></div><div class="line">        app.controller(&apos;add-news&apos;, function ($scope, $http) &#123;</div><div class="line">            $scope.toAdd = function () &#123;</div><div class="line">                $http.get(&apos;news&apos;,&#123;</div><div class="line">                    params:&#123;act:&apos;add&apos;,title:$scope.title,href:$scope.href&#125;,</div><div class="line">                    responseType:&apos;json&apos;//</div><div class="line">                &#125;).success(function(res)&#123;</div><div class="line">                    alert(res.msg);</div><div class="line">                &#125;).error(function (err) &#123;</div><div class="line">                    console.log(err);</div><div class="line">                &#125;)</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;body ng-app=&quot;app&quot;&gt;</div><div class="line">    &lt;div id=&quot;box&quot; ng-controller=&quot;add-news&quot;&gt;</div><div class="line">        &lt;h3&gt;添加新闻页面&lt;/h3&gt;</div><div class="line">        title:</div><div class="line">        &lt;input type=&quot;text&quot; id=&quot;t1&quot; ng-model=&quot;title&quot;&gt;</div><div class="line">        &lt;br&gt;</div><div class="line">        href:</div><div class="line">        &lt;input type=&quot;text&quot; id=&quot;t2&quot; ng-model=&quot;href&quot;&gt;</div><div class="line">        &lt;br&gt;</div><div class="line">        &lt;input type=&quot;button&quot; value=&quot;添加&quot; id=&quot;btn1&quot; ng-click=&quot;toAdd()&quot;&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h5 id="get-news-html"><a href="#get-news-html" class="headerlink" title="get_news.html"></a>get_news.html</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">    var app=angular.module(&apos;app&apos;,[]);</div><div class="line"></div><div class="line">    app.controller(&apos;getnews&apos;, function ($scope, $http) &#123;</div><div class="line">            $scope.data=[];</div><div class="line">            $http.get(&apos;news&apos;,&#123;</div><div class="line">                params:&#123;act:&apos;get&apos;&#125;,</div><div class="line">                responseType:&apos;json&apos;//</div><div class="line">            &#125;).success(function(res)&#123;</div><div class="line">                console.log(res);</div><div class="line">                $scope.data=res.data;</div><div class="line">            &#125;).error(function (err) &#123;</div><div class="line">                console.log(err);</div><div class="line">            &#125;)</div><div class="line">    &#125;)</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;body ng-app=&quot;app&quot;&gt;</div><div class="line">    &lt;div id=&quot;box&quot; ng-controller=&quot;getnews&quot;&gt;</div><div class="line">        &lt;h2&gt;读取新闻列表&lt;/h2&gt;</div><div class="line">        &lt;ul&gt;</div><div class="line">            &lt;li ng-repeat=&quot;item in data&quot;&gt;&lt;a href=&quot;&#123;&#123;item.href&#125;&#125;&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/a&gt;&lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h4 id="接口说明"><a href="#接口说明" class="headerlink" title="接口说明:"></a>接口说明:</h4><pre><code>1001    数据库方面有问题

1002    新闻添加成功

1003    获取新闻成功

1004    获取新闻失败
</code></pre><h4 id="添加"><a href="#添加" class="headerlink" title="添加:"></a>添加:</h4><pre><code>news?act=add&amp;title=xxx&amp;href=xxx

    return  {code:1001/1002, msg:&quot;&quot;}
</code></pre><h4 id="获取"><a href="#获取" class="headerlink" title="获取:"></a>获取:</h4><pre><code>news?act=get
</code></pre><h4 id="引入模块"><a href="#引入模块" class="headerlink" title="引入模块"></a>引入模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">const http = require(&apos;http&apos;);</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line">const os = require(&apos;os&apos;);</div><div class="line">const cluster = require(&apos;cluster&apos;);</div><div class="line">const EventEmitter = require(&apos;events&apos;).EventEmitter;</div><div class="line">const mysql=require(&apos;mysql&apos;)</div><div class="line">const urlLib=require(&apos;url&apos;);</div><div class="line"></div><div class="line">var cpus=os.cpus().length;//获取cpu核数</div></pre></td></tr></table></figure>
<h4 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if(cluster.isMaster)&#123;</div><div class="line">    for(var i=0;i&lt;cpus;i++)&#123;</div><div class="line">        cluster.fork();</div><div class="line">    &#125;</div><div class="line">    cluster.on(&apos;exit&apos;, function () &#123;</div><div class="line">        cluster.fork()</div><div class="line">    &#125;)</div><div class="line">&#125;else&#123;</div><div class="line">    //工作进程</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="在工作进程写业务逻辑"><a href="#在工作进程写业务逻辑" class="headerlink" title="在工作进程写业务逻辑"></a>在工作进程写业务逻辑</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">//添加事件驱动</div><div class="line">var E=new EventEmitter();</div><div class="line">//http服务</div><div class="line">http.createServer(function (req, res) &#123;</div><div class="line">    //get数据解析发布</div><div class="line">    E.emit(&apos;get-parse&apos;,req,res);</div><div class="line">&#125;).listen(8080);</div><div class="line"></div><div class="line">//get订阅</div><div class="line">E.on(&apos;get-parse&apos;, function (req, res) &#123;</div><div class="line">    //获取get参数</div><div class="line">    req.get=urlLib.parse(req.url,true).query;</div><div class="line">    //获取get url</div><div class="line">    req.url=urlLib.parse(req.url,true).pathname;</div><div class="line">    //业务-发布</div><div class="line">    E.emit(&apos;buss-on&apos;,req,res);</div><div class="line">&#125;)</div><div class="line"></div><div class="line">E.on(&apos;buss-on&apos;, function (req, res) &#123;</div><div class="line">    var bool=E.emit(req.url,req,res);</div><div class="line">    //未定义的接口都返回false</div><div class="line">    if(bool == false)&#123;</div><div class="line">        //IO读写</div><div class="line">        E.emit(&apos;read-file&apos;,req,res);</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">E.on(&apos;read-file&apos;, function (req, res) &#123;</div><div class="line">    //加载页面</div><div class="line">    var rs=fs.createReadStream(&apos;www&apos;+req.url);</div><div class="line">    rs.pipe(res);</div><div class="line">    rs.on(&apos;error&apos;, function () &#123;</div><div class="line">        res.writeHeader(404);</div><div class="line">        res.write(&apos;404&apos;);</div><div class="line">        res.end();</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">//以下处理接口</div><div class="line">E.on(&apos;/news&apos;, function (req, res) &#123;</div><div class="line">//获取get-act参数 add为添加，get为查询</div><div class="line">    var act=req.get.act;</div><div class="line">    switch (act)&#123;</div><div class="line">        case &apos;add&apos;:</div><div class="line">            E.emit(&apos;news-add&apos;,req,res);</div><div class="line">            break;</div><div class="line">        case &apos;get&apos;:</div><div class="line">            E.emit(&apos;news-get&apos;,req,res);</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"></div><div class="line">//添加新闻</div><div class="line">E.on(&apos;news-add&apos;, function (req,res) &#123;</div><div class="line">        //获取get参数</div><div class="line">        var title=req.get.title;</div><div class="line">        var href=req.get.href;</div><div class="line"></div><div class="line">        //连接数据库</div><div class="line">        var db=mysql.createConnection(&#123;</div><div class="line">            host:       &apos;localhost&apos;,</div><div class="line">            user:       &apos;root&apos;,</div><div class="line">            password:   &apos;root&apos;,</div><div class="line">            database:   &apos;user&apos;</div><div class="line">        &#125;)</div><div class="line">        //var sql=&apos;INSERT INTO news VALUES(null,&quot;&apos;+title+&apos;&quot;,&quot;&apos;+href+&apos;&quot;)&apos;;</div><div class="line">        var sql=`INSERT INTO news VALUES(null,&quot;$&#123;title&#125;&quot;,&quot;$&#123;href&#125;&quot;)`;//es6字符串拼接 `&quot;$&#123;str&#125;&quot;`</div><div class="line">        db.query(sql, function (err, data) &#123;</div><div class="line">            if(err)&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1001,msg:&quot;数据库方面问题&quot;&#125;))</div><div class="line">            &#125;else&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1002,msg:&quot;添加新闻成功&quot;&#125;))</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">//查询</div><div class="line">E.on(&apos;news-get&apos;, function (req, res) &#123;</div><div class="line">        var db=mysql.createConnection(&#123;</div><div class="line">            host:       &apos;localhost&apos;,</div><div class="line">            user:       &apos;root&apos;,</div><div class="line">            password:   &apos;root&apos;,</div><div class="line">            database:   &apos;user&apos;</div><div class="line">        &#125;)</div><div class="line">        var sql=`SELECT title,href FROM news`;</div><div class="line">        db.query(sql, function (err, data) &#123;</div><div class="line">            if(err)&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1001,msg:&quot;数据库方面问题&quot;&#125;))</div><div class="line">            &#125;else&#123;</div><div class="line">                res.end(JSON.stringify(&#123;err:1002,msg:&quot;获取新闻成功&quot;,data:data&#125;))</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
<h4 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h4><p><a href="https://github.com/cuteshen/node-mysql-news" target="_blank" rel="external">https://github.com/cuteshen/node-mysql-news</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/01/NodeJs——多进程/" itemprop="url">
                  NodeJs——多进程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-01T17:17:36+08:00" content="2016-09-01">
              2016-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/01/NodeJs——多进程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/01/NodeJs——多进程/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>nodejs是一个单进程单线程的服务器引擎，不管有多么的强大硬件，只能利用到单个CPU进行计算。所以，有人开发了第三方的cluster，让node可以利用多核CPU实现并行。</p>
<p>在V0.6.0版本，Nodejs内置了cluster的特性。</p>
</blockquote>
<h5 id="下面介绍cluster的用法："><a href="#下面介绍cluster的用法：" class="headerlink" title="下面介绍cluster的用法："></a>下面介绍cluster的用法：</h5><h2 id="cluster-——集群"><a href="#cluster-——集群" class="headerlink" title="cluster:——集群"></a>cluster:——集群</h2><p>”集群“——一堆物理机器，组合起来变成并行网络</p>
<p>cluster——一个进程、分裂出很多子进程(对应的就是cpu核数)</p>
<h3 id="主进程的工作"><a href="#主进程的工作" class="headerlink" title="主进程的工作:"></a>主进程的工作:</h3><p>a). 分裂工作进程</p>
<p>b). 子进程崩溃，重启</p>
<h3 id="子进程-工作进程"><a href="#子进程-工作进程" class="headerlink" title="子进程(工作进程):"></a>子进程(工作进程):</h3><p>主要工作，文件读取、服务器搭建…..</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre><code>const cluster=require(&apos;cluter&apos;);
</code></pre><p>判断主进程还是工作进程</p>
<pre><code>cluster.isMaster        是否是主进程
cluster.isWorker            是否是工作进程
</code></pre><p>进程进程id:  pid</p>
<pre><code>process.pid
</code></pre><p>子进程崩溃事件:</p>
<pre><code>cluster.on(&apos;exit&apos;,function(){  //有人崩溃

})
</code></pre><p>实际应用</p>
<pre><code>//有子进程崩溃了
cluster.on(&apos;exit&apos;,function(worker,code,signal){
     //打印崩溃子进程的id
    console.log(worker.id);
    //重启进程
    cluster.fork();
});
</code></pre><p>实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line">const os=require(&apos;os&apos;);</div><div class="line">const cluster=require(&apos;cluster&apos;);</div><div class="line"></div><div class="line">//获取cpu核数</div><div class="line">var cpus=os.cpus().length;</div><div class="line"></div><div class="line">if(cluster.isMaster)&#123;</div><div class="line">    //主进程</div><div class="line">    //分裂</div><div class="line">    for(var i=0;i&lt;cpus; i++)&#123;</div><div class="line">        cluster.fork();</div><div class="line">    &#125;</div><div class="line">    //子崩溃了</div><div class="line">    cluster.on(&apos;exit&apos;, function (worker,code,signal) &#123;</div><div class="line">        //打印崩溃进程id</div><div class="line">        console.log(worker.id+&apos;崩溃了&apos;);</div><div class="line">        //分裂</div><div class="line">        cluster.fork();</div><div class="line">    &#125;)</div><div class="line">&#125;else&#123;</div><div class="line">    //工作进程</div><div class="line">    console.log(&apos;子进程ID：&apos;+cluster.worker.id);</div><div class="line">    http.createServer(function (req, res) &#123;</div><div class="line">        if(Marh.random() &lt; 0.5)&#123;</div><div class="line">            res.writei(&apos;well&apos;);//此处我故意写错</div><div class="line">            res.end();</div><div class="line">        &#125;else&#123;</div><div class="line">            res.write(&apos;well&apos;);</div><div class="line">            res.end();</div><div class="line">        &#125;</div><div class="line">    &#125;).listen(8080);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">子进程ID：1</div><div class="line">子进程ID：3</div><div class="line">子进程ID：2</div><div class="line">子进程ID：4</div><div class="line">d:\myjob\sql_cluster_md5\cluster.js:26</div><div class="line">        if(Marh.random() &lt; 0.5)&#123;</div><div class="line">           ^</div><div class="line"></div><div class="line">ReferenceError: Marh is not defined</div><div class="line">    at Server.&lt;anonymous&gt; (d:\myjob\sql_cluster_md5\cluster.js:26:12)</div><div class="line">    at emitTwo (events.js:87:13)</div><div class="line">    at Server.emit (events.js:172:7)</div><div class="line">    at HTTPParser.parserOnIncoming [as onIncoming] (_http_server.js:527:12)</div><div class="line">    at HTTPParser.parserOnHeadersComplete (_http_common.js:88:23)</div><div class="line">d:\myjob\sql_cluster_md5\cluster.js:26</div><div class="line">        if(Marh.random() &lt; 0.5)&#123;</div><div class="line">           ^</div><div class="line"></div><div class="line">ReferenceError: Marh is not defined</div><div class="line">    at Server.&lt;anonymous&gt; (d:\myjob\sql_cluster_md5\cluster.js:26:12)</div><div class="line">    at emitTwo (events.js:87:13)</div><div class="line">    at Server.emit (events.js:172:7)</div><div class="line">    at HTTPParser.parserOnIncoming [as onIncoming] (_http_server.js:527:12)</div><div class="line">    at HTTPParser.parserOnHeadersComplete (_http_common.js:88:23)</div><div class="line">4崩溃了</div><div class="line">2崩溃了</div><div class="line">子进程ID：5</div><div class="line">子进程ID：6</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/01/NodeJs——文件下载/" itemprop="url">
                  NodeJs——文件下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-01T17:16:59+08:00" content="2016-09-01">
              2016-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/01/NodeJs——文件下载/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/01/NodeJs——文件下载/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在node中，实现文件下载，只需设置header即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.setHeader(&apos;content-disposition&apos;,&apos;attachment&apos;);  //所有文件都下载</div></pre></td></tr></table></figure>
<p>另外attachment后还有个filename参数，用来定义下载文件名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">res.setHeader(&apos;content-disposition&apos;,&apos;attachment;filename=&quot;xxx.xxx&quot;&apos;);</div></pre></td></tr></table></figure>
<p>用一个小例子体现一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line">const path=require(&apos;path&apos;);</div><div class="line"></div><div class="line">http.createServer(function (req, res) &#123;</div><div class="line">    //获取url</div><div class="line">    var rs=fs.createReadStream(req.url.substring(1));</div><div class="line">    //定义可下载文件组</div><div class="line">    var downloadType=[&apos;.rar&apos;,&apos;.exe&apos;,&apos;.png&apos;,&apos;.jpg&apos;];</div><div class="line">    //获取文件后缀名</div><div class="line">    var extname=path.extname(req.url);</div><div class="line"></div><div class="line">    if(downloadType.indexOf(extname) != -1)&#123;</div><div class="line">        //时间戳</div><div class="line">        var filename=Date.now();</div><div class="line">        //写入头-content-disposition,attachment;filename&apos;&apos;;</div><div class="line">        res.setHeader(`content-disposition`,`attachment;filename=&quot;$&#123;filename&#125;$&#123;extname&#125;&quot;`);</div><div class="line">        //写入res</div><div class="line">        rs.pipe(res);</div><div class="line">    &#125;else&#123;</div><div class="line">        rs.pipe(res);</div><div class="line">    &#125;</div><div class="line">    rs.on(&apos;error&apos;, function () &#123;</div><div class="line">        res.writeHeader(404);</div><div class="line">        res.write(&apos;404&apos;);</div><div class="line">        res.end();</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">&#125;).listen(8080)</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/19/前端自动化构建工具-gulp/" itemprop="url">
                  前端自动化构建工具-gulp
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-19T14:56:41+08:00" content="2016-08-19">
              2016-08-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/19/前端自动化构建工具-gulp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/19/前端自动化构建工具-gulp/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>利用 Node.js 流实现前端资源文件的IO操作，其中包括第三方模块，需单独下载</p>
<p>先贴出官网的入门实例：</p>
<h3 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h3><pre><code>npm install --global gulp
</code></pre><h3 id="作为项目的开发依赖（devDependencies）安装："><a href="#作为项目的开发依赖（devDependencies）安装：" class="headerlink" title="作为项目的开发依赖（devDependencies）安装："></a>作为项目的开发依赖（devDependencies）安装：</h3><pre><code>npm install --save-dev gulp
</code></pre><h3 id="在项目根目录下创建一个名为-gulpfile-js-的文件"><a href="#在项目根目录下创建一个名为-gulpfile-js-的文件" class="headerlink" title="在项目根目录下创建一个名为 gulpfile.js 的文件"></a>在项目根目录下创建一个名为 gulpfile.js 的文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var gulp = require(&apos;gulp&apos;);</div><div class="line"></div><div class="line">gulp.task(&apos;default&apos;, function() &#123;</div><div class="line">    // 将你的默认的任务代码放在这</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接下来开始我们的代码:</p>
<blockquote>
<p>gulp-minify-css,gulp-less等第三方模块需通过npm去安装，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 引入 gulp及组件</div><div class="line">var gulp = require(&apos;gulp&apos;),</div><div class="line">    minifycss = require(&apos;gulp-minify-css&apos;),</div><div class="line">    less = require(&apos;gulp-less&apos;),</div><div class="line">    concat = require(&apos;gulp-concat&apos;),</div><div class="line">    uglify = require(&apos;gulp-uglify&apos;),</div><div class="line">    rename = require(&apos;gulp-rename&apos;),</div><div class="line">    jshint = require(&apos;gulp-jshint&apos;),</div><div class="line">    spritesmith = require(&apos;gulp.spritesmith&apos;);</div><div class="line"></div><div class="line">//定义项目目录</div><div class="line">option = &#123;</div><div class="line">    buildPath: &quot;&quot;,//构建目录</div><div class="line">    jsItem: []</div><div class="line">    //我这里只是为了操作指定的几个js文件，具体看资源目录</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="定义编译less文件的任务"><a href="#定义编译less文件的任务" class="headerlink" title="定义编译less文件的任务"></a>定义编译less文件的任务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;lessback&apos;, function () &#123;</div><div class="line">    return gulp.src(option.buildPath + &apos;/less/*.less&apos;)//指定操作目录</div><div class="line">        .pipe(less())           //执行编译</div><div class="line">        .pipe(minifycss())      //执行压缩</div><div class="line">        .pipe(concat(&apos;mainLess.css&apos;)) //合并</div><div class="line">        .pipe(gulp.dest(option.buildPath + &apos;/cssmin/&apos;));//输出文件夹</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="压缩普通css"><a href="#压缩普通css" class="headerlink" title="压缩普通css"></a>压缩普通css</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;minifycss&apos;, function () &#123;</div><div class="line">    return gulp.src(option.buildPath + &apos;/css/*.css&apos;) //需要操作的文件</div><div class="line">        .pipe(rename(&#123;suffix: &apos;.min&apos;&#125;)) //rename压缩后的文件名</div><div class="line">        .pipe(minifycss())              //执行压缩</div><div class="line">        .pipe(concat(&apos;main.css&apos;))           //合并</div><div class="line">        .pipe(gulp.dest(option.buildPath + &apos;/cssmin/&apos;)); //输出文件夹</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="js语法检查"><a href="#js语法检查" class="headerlink" title="js语法检查"></a>js语法检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;jshint&apos;, function () &#123;</div><div class="line">    return gulp.src(option.buildPath + &apos;/js/*.js&apos;)</div><div class="line">        .pipe(jshint())</div><div class="line">        .pipe(jshint.reporter(&apos;default&apos;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="压缩-合并-js"><a href="#压缩-合并-js" class="headerlink" title="压缩,合并 js"></a>压缩,合并 js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;minifyjs&apos;, function () &#123;</div><div class="line">    return gulp.src(option.jsItem)    //需要操作的文件</div><div class="line">        .pipe(concat(&apos;all.js&apos;))       //合并所有js到all.js</div><div class="line">        .pipe(gulp.dest(option.buildPath + &apos;/jsmin/&apos;)) //输出到文件夹</div><div class="line">        .pipe(rename(&#123;suffix: &apos;.min&apos;&#125;))     //rename压缩后的文件名</div><div class="line">        .pipe(uglify())    //压缩</div><div class="line">        .pipe(gulp.dest(option.buildPath + &apos;/jsmin/&apos;));  //输出</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在cmd中输入gulp后,执行的就是这个任务(压缩js需要在检查js之后操作)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;default&apos;, function () &#123;</div><div class="line">    option.buildPath = &quot;project/src&quot;;</div><div class="line">    //也可以直接操作整个js目录，通过 *.js去匹配</div><div class="line">    option.jsItem = [option.buildPath + &quot;/js/script.js&quot;, option.buildPath + &quot;/js/script2.js&quot;];</div><div class="line">    gulp.start(&apos;lessback&apos;, &apos;jshint&apos;, &apos;minifycss&apos;, &apos;minifyjs&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>cmd输如gulp后，默认执行default，通过gulp.start执行上面所定义的方法即可执行;</p>
<h3 id="gulp将多张图片自动合成雪碧图"><a href="#gulp将多张图片自动合成雪碧图" class="headerlink" title="gulp将多张图片自动合成雪碧图"></a>gulp将多张图片自动合成雪碧图</h3><blockquote>
<p>再也不用拿ps去一张一张去拼图了</p>
</blockquote>
<p><img src="/img/16081902.png" alt="img"></p>
<p>首先安装模块并引入</p>
<pre><code>npm install gulp.spritesmith
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var spritesmith=require(‘gulp.spritesmith‘);</div><div class="line"></div><div class="line">gulp.task(&apos;sprite&apos;, function () &#123;</div><div class="line">    console.log(option.buildPath +&apos;/images/&apos;);</div><div class="line">    return gulp.src(option.buildPath +&apos;/images/*.png&apos;)//需要合并的图片地址</div><div class="line">        .pipe(spritesmith(&#123;</div><div class="line">            imgName: &apos;sprite/images/sprite.png&apos;,//保存合并后图片的地址</div><div class="line">            cssName: &apos;sprite/css/sprite.css&apos;,//保存合并后对于css样式的地址</div><div class="line">            padding: 5,//合并时两个图片的间距</div><div class="line">            algorithm: &apos;binary-tree&apos;,//注释1</div><div class="line">            cssTemplate:option.buildPath+&quot;/images/sprite/model/handlebarsStr.css&quot;//注释2</div><div class="line">        &#125;))</div><div class="line">        .pipe(gulp.dest(option.buildPath+&apos;/images/&apos;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注释一：</p>
<p>Algorithm 有四个可选值分别为top-down、left-right、diagonal、alt-diagonal、binary-tree</p>
<p><img src="/img/16081901.png" alt="img"></p>
<p>注释二：</p>
<p>cssTemplate 是生成css的模板文件可以是字符串也可以是函数。是字符串是对于相对于的模板地址 对于模板文件样式格式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;&#123;#sprites&#125;&#125;</div><div class="line">.icon-&#123;&#123;name&#125;&#125;&#123;</div><div class="line">    background-image: url(&quot;&#123;&#123;escaped_image&#125;&#125;&quot;);</div><div class="line">    background-position: &#123;&#123;px.offset_x&#125;&#125; &#123;&#123;px.offset_y&#125;&#125;;</div><div class="line">    width: &#123;&#123;px.width&#125;&#125;;</div><div class="line">    height: &#123;&#123;px.height&#125;&#125;;</div><div class="line">&#125;</div><div class="line">&#123;&#123;/sprites&#125;&#125;</div></pre></td></tr></table></figure>
<p>——模版文件需要提前再项目目录下创建，并通过cssTemplate指定位置</p>
<p>如果是函数的话，这可以这样写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;sprite&apos;, function () &#123;</div><div class="line">    console.log(option.buildPath +&apos;/images/&apos;);</div><div class="line">    return gulp.src(option.buildPath +&apos;/images/*.png&apos;)//需要合并的图片地址</div><div class="line">        .pipe(spritesmith(&#123;</div><div class="line">            imgName: &apos;sprite/images/sprite.png&apos;,//保存合并后图片的地址</div><div class="line">            cssName: &apos;sprite/css/sprite.css&apos;,//保存合并后对于css样式的地址</div><div class="line">            padding: 5,//合并时两个图片的间距</div><div class="line">            algorithm: &apos;binary-tree&apos;,//注释1</div><div class="line">            cssTemplate: function (data) &#123;</div><div class="line">                var arr=[];</div><div class="line">                data.sprites.forEach(function (sprite) &#123;</div><div class="line">                    arr.push(&quot;.icon-&quot;+sprite.name+</div><div class="line">                    &quot;&#123;&quot; +</div><div class="line">                    &quot;background-image: url(‘&quot;+sprite.escaped_image+&quot;‘);&quot;+</div><div class="line">                    &quot;background-position: &quot;+sprite.px.offset_x+&quot;px &quot;+sprite.px.offset_y+&quot;px;&quot;+</div><div class="line">                    &quot;width:&quot;+sprite.px.width+&quot;;&quot;+</div><div class="line">                    &quot;height:&quot;+sprite.px.height+&quot;;&quot;+</div><div class="line">                    &quot;&#125;\n&quot;);</div><div class="line">                &#125;);</div><div class="line">                return arr.join(&quot;&quot;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;))</div><div class="line">        .pipe(gulp.dest(option.buildPath+&apos;/images/&apos;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>最终再default中gulp.start(‘sprite’)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(&apos;default&apos;, function () &#123;</div><div class="line">    option.buildPath = &quot;project/src&quot;;</div><div class="line">    option.jsItem = [option.buildPath + &quot;/js/script.js&quot;, option.buildPath + &quot;/js/script2.js&quot;];</div><div class="line">    gulp.start(&apos;sprite&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h6 id="到此gulp构建工具就初步完成了，只是初步，待完善。"><a href="#到此gulp构建工具就初步完成了，只是初步，待完善。" class="headerlink" title="到此gulp构建工具就初步完成了，只是初步，待完善。"></a>到此gulp构建工具就初步完成了，只是初步，待完善。</h6>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/19/Nodejs——Stream流/" itemprop="url">
                  Nodejs——Stream流
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-19T13:36:45+08:00" content="2016-08-19">
              2016-08-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/19/Nodejs——Stream流/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/19/Nodejs——Stream流/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>所谓流：就是一组连续的数据（文件流、网络流…)</p>
</blockquote>
<h4 id="之前的文件操作通过通过fs-readFile进行读取有以下弊端"><a href="#之前的文件操作通过通过fs-readFile进行读取有以下弊端" class="headerlink" title="之前的文件操作通过通过fs.readFile进行读取有以下弊端"></a>之前的文件操作通过通过fs.readFile进行读取有以下弊端</h4><p>1,把文件读取到内存中</p>
<p>2,内存不足、卡顿</p>
<p>3,造成 IO峰值</p>
<p>4,数据混乱</p>
<p>5,耗时</p>
<p>6,操作文件会有各种限制（文件大小限制…）</p>
<h4 id="通过流进行文件操作"><a href="#通过流进行文件操作" class="headerlink" title="通过流进行文件操作"></a>通过流进行文件操作</h4><p>流可分为：</p>
<p>1,读取流——req</p>
<p>2,写入流——res</p>
<p>3,读写流——文件压缩</p>
<p>之前创建http服务时有这样的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http.createServer(function(req,res)&#123;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>读取流，就相当于<code>req</code>,写入流就相当于<code>res</code></p>
<p>读写流常用在文件压缩等功能</p>
<h5 id="写入流"><a href="#写入流" class="headerlink" title="写入流"></a>写入流</h5><p>抛开之前的<code>fs.writeFile()</code>方法,将内容写入ccc.txt文件，若没有ccc.txt文件，则创建一个ccc.txt文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">var ws=fs.createWriteStream(&apos;ccc.txt&apos;);  //创建了一个写入流</div><div class="line"></div><div class="line">ws.write(&apos;abcd&apos;);</div><div class="line"></div><div class="line">ws.end();</div><div class="line"></div><div class="line">ws.on(&apos;finish&apos;,function()&#123;</div><div class="line">    console.log(&apos;写入完毕&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h5 id="读取流"><a href="#读取流" class="headerlink" title="读取流"></a>读取流</h5><p>项目目录有一个aaa.txt文件，文件内容为aaa</p>
<p>执行读取:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">var rs=fs.createReadStream(&apos;aaa.txt&apos;);</div><div class="line"></div><div class="line">var arr=[];</div><div class="line"></div><div class="line">rs.on(&apos;data&apos;,function(b)&#123;</div><div class="line">    arr.push(b);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">rs.on(&apos;end&apos;,function()&#123;</div><div class="line">    var buffer=Buffer.concat(arr);</div><div class="line">    console.log(buffer.toString());</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>另外针对stream的err捕获，无法通过try()catch(e){}捕获到，try捕获是程序异常，而流操作，走的是系统；</p>
<p>rs同requst一样有着监听事件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rs.on(&apos;error&apos;,function(err)&#123;</div><div class="line">    console.log(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h5 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h5><p>和unix一样，node stream主要的操作也是.pipe()</p>
<pre><code>源头.pipe(目标)

读取.pipe(写入)
</code></pre><p>将bbb.txt文件内容写入到ddd.txt文件中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">var rs=fs.createReadStream(&apos;bbb.txt&apos;);</div><div class="line">var ws=fs.createWriteStream(&apos;ddd.txt&apos;);</div><div class="line"></div><div class="line">//读取.pipe(写入)</div><div class="line">rs.pipe(ws);</div><div class="line"></div><div class="line">ws.on(&apos;finish&apos;,function()&#123;</div><div class="line">    console.log(&apos;读写完毕&apos;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h5 id="读写流——实现文件压缩"><a href="#读写流——实现文件压缩" class="headerlink" title="读写流——实现文件压缩"></a>读写流——实现文件压缩</h5><blockquote>
<p>需要引入第三方模块<code>zlib</code></p>
</blockquote>
<pre><code>npm install zlib
</code></pre><p>程序代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">const zLib=require(&apos;zlib&apos;);</div><div class="line"></div><div class="line">var gz=zlib.createGzip();//选择压缩模式-gzip</div><div class="line"></div><div class="line">//准备2个流</div><div class="line">var rs=fs.createReadStream(&apos;aaa.txt&apos;);</div><div class="line">var ws=fs.createWriteStream(&apos;aaa.txt.gz&apos;);</div><div class="line"></div><div class="line">//执行压缩</div><div class="line">rs.pipe(gz).pipe(ws);</div></pre></td></tr></table></figure></p>
<p>执行后，项目目录会生成名字为‘aaa.txt.gz’的压缩文件</p>
<blockquote>
<p>gz压缩格式特点——修改.gz文件名称，压缩文件会跟着压缩包名字改变</p>
</blockquote>
<p>执行代码，先对文件进行gzip压缩，再输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line">const zlib=require(&apos;zlib&apos;);</div><div class="line"></div><div class="line">http.createServer(function(req,res)&#123;</div><div class="line">    var gz=zlib.createGzip();</div><div class="line">    var rs=fs.createReadStream(&apos;222.txt&apos;);</div><div class="line"></div><div class="line">    rs.pipe(gz).pipe(res);</div><div class="line"></div><div class="line">&#125;).listen(8081);</div></pre></td></tr></table></figure></p>
<p>此时打开浏览器localhost:8081会直接下载222.txt文件，而不是输出文件内容</p>
<p>设置header</p>
<pre><code>res.setHeader(&apos;content-encoding&apos;,&apos;gzip&apos;)
</code></pre><p>完整代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line">const zlib=require(&apos;zlib&apos;);</div><div class="line"></div><div class="line">http.createServer(function(req,res)&#123;</div><div class="line">    var gz=zlib.createGzip();</div><div class="line">    var rs=fs.createReadStream(&apos;222.txt&apos;);</div><div class="line"></div><div class="line">    res.setHeader(&apos;content-encoding&apos;,&apos;gzip&apos;)</div><div class="line">    rs.pipe(gz).pipe(res);</div><div class="line"></div><div class="line">&#125;).listen(8081);</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/19/split()函数在buffer中的实现/" itemprop="url">
                  split()函数在buffer中的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-19T13:34:01+08:00" content="2016-08-19">
              2016-08-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/19/split()函数在buffer中的实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/19/split()函数在buffer中的实现/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="javascript中的用法："><a href="#javascript中的用法：" class="headerlink" title="javascript中的用法："></a>javascript中的用法：</h2><blockquote>
<p>split() 方法用于把一个字符串分割成字符串数组。</p>
</blockquote>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p>stringObject.split(separator,howmany)</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p><code>separator</code> 必需。字符串或正则表达式，从该参数指定的地方分割 stringObject。</p>
<p><code>howmany</code> 可选。该参数可指定返回的数组的最大长度。如果设置了该参数，返回的子串不会多于这个参数指定的数组。如果没有设置该参数，整个字符串都会被分割，不考虑它的长度。</p>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>一个字符串数组。该数组是通过在 separator 指定的边界处将字符串 stringObject 分割成子串创建的。返回的数组中的字串不包括 separator 自身。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">str=&quot;2,2,3,5,6,6&quot;; //这是一字符串</div><div class="line">var strs= new Array(); //定义一数组</div><div class="line">strs=str.split(&quot;,&quot;); //字符分割</div><div class="line">for (i=0;i&lt;strs.length ;i++ )</div><div class="line">&#123;</div><div class="line">document.write(strs[i]+&quot;&lt;br&gt;&quot;); //分割后的字符输出</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码输出结果为：2 2 3 5 6</p>
<h2 id="buffer中的实现"><a href="#buffer中的实现" class="headerlink" title="buffer中的实现"></a>buffer中的实现</h2><p>nodeJs开发操作buffer时，buffer中是没有split()方法的;</p>
<p>如下代码执行会报错<code>TypeError: buffer.splice is not a function</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var buffer=new Buffer(&apos;width height background apple banana&apos;);</div><div class="line">console.log(buffer.splice(&apos; &apos;))</div></pre></td></tr></table></figure></p>
<p>因此需要自己实现split()方法；</p>
<p>1，toString()，不建议<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var buffer=new Buffer(&apos;width height&apos;);</div><div class="line"></div><div class="line">console.log(buffer.toString().split(&apos; &apos;));</div><div class="line"></div><div class="line">//[ &apos;width&apos;, &apos;height&apos; ]</div></pre></td></tr></table></figure></p>
<p>buffer数据tostring之后，想再回到buffer，数据就被损坏了，因此不建议toString;</p>
<h5 id="通过slice："><a href="#通过slice：" class="headerlink" title="通过slice："></a>通过slice：</h5><p>buffer中是可以使用slice方法的，因此可以通过使用slice() 达到split的效果</p>
<blockquote>
<p>bufferSplit(buffer数据，切割字符串);</p>
</blockquote>
<p>首先创建buffer<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var buffer=new Buffer(&apos;width height background apple banana&apos;);</div></pre></td></tr></table></figure></p>
<p>这时输出buffer是一个连续的文件流<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">console.log(buffer);</div><div class="line">//&lt;Buffer 77 69 64 74 68 20 68 65 69 67 68 74 20 62 61 63 6b 67 72 6f 75 6e 64 20 61 70 70 6c 65 20 62 61 6e 61 6e 61&gt;</div></pre></td></tr></table></figure></p>
<p>若要得到buffer中的某一段数据，则需要先进行切割：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">var buffer=new Buffer(&apos;width height background apple banana&apos;);</div><div class="line">var b=new Buffer(&apos; &apos;); //分割标志</div><div class="line"></div><div class="line">var arr=[];</div><div class="line">var start=0;//开始位置</div><div class="line">var index=0;//b开始的位置</div><div class="line"></div><div class="line">while((index=buffer.indexOf(b,start))!=-1)&#123;</div><div class="line">    arr.push(buffer.slice(start,index));</div><div class="line">    start=index+b.length;</div><div class="line">&#125;</div><div class="line">arr.push(buffer.slice(start));</div><div class="line">console.log(arr);</div><div class="line">//输出结果：</div><div class="line">[ &lt;Buffer 77 69 64 74 68&gt;,</div><div class="line">  &lt;Buffer 68 65 69 67 68 74&gt;,</div><div class="line">  &lt;Buffer 62 61 63 6b 67 72 6f 75 6e 64&gt;,</div><div class="line">  &lt;Buffer 61 70 70 6c 65&gt;,</div><div class="line">  &lt;Buffer 62 61 6e 61 6e 61&gt; ]</div><div class="line"></div><div class="line">console.log(arr.toString());</div><div class="line">//输出结果:width,height,background,apple,banana</div></pre></td></tr></table></figure></p>
<p>实际应用中，可以将此方法进行封装，或以模块的形式导入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function bufferSplit(buffer,spliter)&#123;</div><div class="line">    var b=new Buffer(spliter);</div><div class="line">    var arr=[];</div><div class="line">    var start=0;</div><div class="line">    var index=0;</div><div class="line">    while((index=buffer.indexOf(b,start))!=-1)&#123;</div><div class="line">        arr.push(buffer.slice(start,index));</div><div class="line">        start=index+b.length;</div><div class="line">    &#125;</div><div class="line">    arr.push(buffer.slice(start));</div><div class="line">    return arr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/NodeJs——post第三方模块/" itemprop="url">
                  NodeJs——post第三方模块
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-16T17:47:08+08:00" content="2016-08-16">
              2016-08-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/16/NodeJs——post第三方模块/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/16/NodeJs——post第三方模块/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上篇写了post数据multipart/form-data形式的文件上传方法，既然代码那么多，那不如直接用第三方模块去实现，一边提升开发效率，介绍2个第三方模块，分别是formidable和multer</p>
<h3 id="formidable"><a href="#formidable" class="headerlink" title="formidable"></a>formidable</h3><blockquote>
<p>以文件形式上传</p>
</blockquote>
<p>首先需要从npm安装模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install formidable</div></pre></td></tr></table></figure>
<p>html代码,file-multiple可上传多个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;http://localhost:8080/abc&quot; method=&quot;post&quot;  enctype=&quot;multipart/form-data&quot; &gt;</div><div class="line">    &lt;input type=&quot;text&quot; name=&quot;name&quot; id=&quot;name&quot;/&gt;</div><div class="line">    &lt;br/&gt;</div><div class="line">    &lt;input type=&quot;text&quot; name=&quot;age&quot; id=&quot;age&quot;/&gt;</div><div class="line">    &lt;br/&gt;</div><div class="line">    &lt;input type=&quot;file&quot; name=&quot;pic&quot; id=&quot;pic&quot; multiple/&gt;</div><div class="line">    &lt;input type=&quot;submit&quot;/&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure></p>
<p>node代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const formidable=require(&apos;formidable&apos;);</div><div class="line"></div><div class="line">http.createServer(function(req,res)&#123;</div><div class="line">    //需要实例化formidable模块中的IncomingForm()方法</div><div class="line">    var form=new formidable.IncomingForm();</div><div class="line"></div><div class="line">    form.parse(req,function(err,fileds,files)&#123;</div><div class="line">        console.log(fileds, files);</div><div class="line">    &#125;);</div><div class="line">&#125;).listen(8081);</div></pre></td></tr></table></figure>
<p>表单填写：name:abc; age:abc; pic:1.jpg,pic:2.jpg提交表单</p>
<p>fileds为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123; name: &apos;abc&apos;, age: &apos;abc&apos; &#125;</div></pre></td></tr></table></figure>
<p>files为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123; pic:</div><div class="line">   [ File &#123;</div><div class="line">       domain: null,</div><div class="line">       _events: &#123;&#125;,</div><div class="line">       _eventsCount: 0,</div><div class="line">       _maxListeners: undefined,</div><div class="line">       size: 693534,</div><div class="line">       path: &apos;upload\\upload_701ff760b9dcba389d87dcb89d93adfb&apos;,</div><div class="line">       name: &apos;1.jpg&apos;,</div><div class="line">       type: &apos;image/jpeg&apos;,</div><div class="line">       hash: null,</div><div class="line">       lastModifiedDate: Tue Aug 16 2016 17:26:50 GMT+0800 (中国标准时间),</div><div class="line">       _writeStream: [Object] &#125;,</div><div class="line">     File &#123;</div><div class="line">       domain: null,</div><div class="line">       _events: &#123;&#125;,</div><div class="line">       _eventsCount: 0,</div><div class="line">       _maxListeners: undefined,</div><div class="line">       size: 232615,</div><div class="line">       path: &apos;upload\\upload_a00ba7289c3690b2d45aa2910a84d0f1&apos;,</div><div class="line">       name: &apos;2.jpg&apos;,</div><div class="line">       type: &apos;image/jpeg&apos;,</div><div class="line">       hash: null,</div><div class="line">       lastModifiedDate: Tue Aug 16 2016 17:26:50 GMT+0800 (中国标准时间),</div><div class="line">       _writeStream: [Object] &#125; ] &#125;</div></pre></td></tr></table></figure></p>
<p>其中几个常用的字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">files.pic</div><div class="line">	.size</div><div class="line">	.path	//临时把文件放到 c盘里面</div><div class="line">	.name</div><div class="line">	.type</div><div class="line">	.lastModifiedDate</div></pre></td></tr></table></figure></p>
<p>其中path是没有后缀名的文件名称，因此需要用到fs.rename方法将后缀名添加进去</p>
<p>完整代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const formidable=require(&apos;formidable&apos;);</div><div class="line">const path=require(&apos;path&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">http.createServer(function (req, res) &#123;</div><div class="line">    var form= new formidable.IncomingForm();</div><div class="line">    form.uploadDir=&apos;upload&apos;;</div><div class="line">    form.multiples=true;</div><div class="line"></div><div class="line">    form.parse(req, function(err, fields, files) &#123;</div><div class="line">        var arrFiles=files.pic;</div><div class="line">        for(var i=0; i &lt; arrFiles.length; i++)&#123;</div><div class="line">            //获取文件后缀名</div><div class="line">            var extname=path.extname(arrFiles[i].name);</div><div class="line">            //修改path名称，添加后缀名</div><div class="line">            fs.rename(arrFiles[i].path,arrFiles[i].path+extname, function (err) &#123;</div><div class="line">                console.log(err);</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;).listen(8080);</div></pre></td></tr></table></figure>
<h4 id="multer"><a href="#multer" class="headerlink" title="multer"></a>multer</h4><blockquote>
<p>以二进制流形式上传</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install multer</div></pre></td></tr></table></figure>
<p>设置上传目录，及文件类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var multer=multerLib(&#123;dest:&apos;upload&apos;&#125;);//设置文件上传路径</div><div class="line">var multerHandler=multer.any();//设置文件类型为任何类型</div></pre></td></tr></table></figure></p>
<p>回调方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">multerHandler(req,res,function()&#123;</div><div class="line">    console.log(req.body.name);//user内容</div><div class="line">    console.log(req.body.age);//age内容</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>其中req.files内容为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[ &#123; fieldname: &apos;pic&apos;,</div><div class="line">    originalname: &apos;1.jpg&apos;,</div><div class="line">    encoding: &apos;7bit&apos;,</div><div class="line">    mimetype: &apos;image/png&apos;,</div><div class="line">    destination: &apos;upload&apos;,</div><div class="line">    filename: &apos;82519811ec7e4793c658e6dbd75dcd6a&apos;,</div><div class="line">    path: &apos;upload\\82519811ec7e4793c658e6dbd75dcd6a&apos;,</div><div class="line">    size: 693534 &#125;,</div><div class="line">  &#123; fieldname: &apos;pic&apos;,</div><div class="line">    originalname: &apos;2.jpg&apos;,</div><div class="line">    encoding: &apos;7bit&apos;,</div><div class="line">    mimetype: &apos;image/jpeg&apos;,</div><div class="line">    destination: &apos;upload&apos;,</div><div class="line">    filename: &apos;7f3b211b0127e872e9ca0bd1d6dea6a7&apos;,</div><div class="line">    path: &apos;upload\\7f3b211b0127e872e9ca0bd1d6dea6a7&apos;,</div><div class="line">    size: 232615 &#125; ]</div></pre></td></tr></table></figure></p>
<p>重写名称，添加后缀<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">for(var files in req.files)&#123;</div><div class="line">    //获取后缀名</div><div class="line">    var extname=path.extname(req.files[files].originalname);</div><div class="line">    //重写文件名称</div><div class="line">    fs.rename(req.files[files].path,req.files[files].path+extname, function (err) &#123;</div><div class="line">        console.log(err);</div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>完整代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const multerLib=require(&apos;multer&apos;);</div><div class="line">const path=require(&apos;path&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">http.createServer(function (req, res) &#123;</div><div class="line">    var multer=multerLib(&#123;dest:&apos;upload&apos;&#125;);</div><div class="line">    var multerHandler=multer.any();</div><div class="line"></div><div class="line">    multerHandler(req,res,function()&#123;</div><div class="line">        console.log(req.files);</div><div class="line"></div><div class="line">        for(var files in req.files)&#123;</div><div class="line">            var extname=path.extname(req.files[files].originalname);</div><div class="line">            console.log(req.files[files].originalname);</div><div class="line">            fs.rename(req.files[files].path,req.files[files].path+extname, function (err) &#123;</div><div class="line">                console.log(err);</div><div class="line">            &#125;)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;).listen(8080);</div></pre></td></tr></table></figure></p>
<p>两个模块具体api信息，还需参阅npm官网</p>
<p><a href="https://www.npmjs.com/package/formidable" target="_blank" rel="external">https://www.npmjs.com/package/formidable</a></p>
<p><a href="https://www.npmjs.com/package/multer" target="_blank" rel="external">https://www.npmjs.com/package/multer</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/16/NodeJs——post数据深入解析/" itemprop="url">
                  NodeJs——post数据深入解析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-16T17:42:03+08:00" content="2016-08-16">
              2016-08-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/16/NodeJs——post数据深入解析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/16/NodeJs——post数据深入解析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="multipart-form-data和application-x-www-form-urlencoded的区别"><a href="#multipart-form-data和application-x-www-form-urlencoded的区别" class="headerlink" title="multipart/form-data和application/x-www-form-urlencoded的区别"></a>multipart/form-data和application/x-www-form-urlencoded的区别</h3><p>FORM元素的enctype属性指定了表单数据向服务器提交时所采用的编码类型，默认的缺省值是<code>application/x-www-form-urlencoded</code>。</p>
<p>然而，在向服务器发送大量的文本、包含非ASCII字符的文本或二进制数据时这种编码方式效率很低。</p>
<p>  在文件上载时，所使用的编码类型应当是<code>multipart/form-data</code>，它既可以发送文本数据，也支持二进制数据上载。</p>
<p>客户端端<code>&lt;form&gt;</code>表单的ENCTYPE属性值为<code>multipart/form-data</code>，它告诉我们传输的数据要用到多媒体传输协议，由于多媒体传输的都是大量的数据，所以规定上传文件必须是post方法，<code>&lt;input&gt;</code>的type属性必须是file。</p>
<h3 id="通过multipart-form-data获取数据"><a href="#通过multipart-form-data获取数据" class="headerlink" title="通过multipart/form-data获取数据"></a>通过<code>multipart/form-data</code>获取数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;http://localhost:8081/abc&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">    user:</div><div class="line">    &lt;input type=&quot;text&quot; name=&quot;user&quot;&gt;</div><div class="line">    &lt;br&gt;</div><div class="line">    &lt;input type=&quot;file&quot; name=&quot;file1&quot;&gt;</div><div class="line">    &lt;br&gt;</div><div class="line">    &lt;input type=&quot;submit&quot;&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<p>提交后，通过<code>req.headers[&#39;content-type&#39;]</code>得到的数据是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">multipart/form-data; boundary=----WebKitFormBoundaryqFAIe2bYb7F35kSq</div></pre></td></tr></table></figure>
<h4 id="执行post数据解析相关操作获取post信息"><a href="#执行post数据解析相关操作获取post信息" class="headerlink" title="执行post数据解析相关操作获取post信息"></a>执行post数据解析相关操作获取post信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">var arr=[];</div><div class="line">req.on(&apos;data&apos;,function(s)&#123;</div><div class="line">    arr.push(s);</div><div class="line">&#125;);</div><div class="line"> req.on(&apos;end&apos;,function()&#123;</div><div class="line">    var buffer=Buffer.concat(arr);</div><div class="line">    //console.log(buffer.toString());</div><div class="line">    if(mime==&apos;multipart/form-data&apos;)&#123;</div><div class="line">        //文件型</div><div class="line">    &#125;else&#123;</div><div class="line">        //普通post数据</div><div class="line">        post=querystring.parse(buffer.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    console.log(post);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上述代码中所获取的post信息存在arr中，并通过Buffer.concat拼接</p>
<p>所得到的内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">------WebKitFormBoundaryLBhBQAIOiPjVA13J</div><div class="line">Content-Disposition: form-data; name=&quot;user&quot;</div><div class="line"></div><div class="line">myname</div><div class="line">------WebKitFormBoundaryLBhBQAIOiPjVA13J</div><div class="line">Content-Disposition: form-data; name=&quot;file1&quot;; filename=&quot;右上角LOGO.jpg&quot;</div><div class="line">Content-Type: image/jpeg</div><div class="line"></div><div class="line">//此处为图片二进制流信息，太长了就不复制进来了</div></pre></td></tr></table></figure>
<p>通过一些列字符串操作及切割方法最终要得到表单信息<code>user</code>及<code>file</code>，下面是所有的代码</p>
<h4 id="创建http服务"><a href="#创建http服务" class="headerlink" title="创建http服务"></a>创建http服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">const http=require(&apos;http&apos;);</div><div class="line">const querystring=require(&apos;querystring&apos;);</div><div class="line">const fs=require(&apos;fs&apos;);</div><div class="line"></div><div class="line">http.createServer(function(req,res)&#123;</div><div class="line"></div><div class="line">    parsePostDeep(req,function(fileds,files)&#123;</div><div class="line">        console.log(fileds,files)</div><div class="line">    &#125;);</div><div class="line"></div><div class="line"></div><div class="line">&#125;).listen(8081);</div></pre></td></tr></table></figure>
<h4 id="解析multipart-form-data信息"><a href="#解析multipart-form-data信息" class="headerlink" title="解析multipart/form-data信息"></a>解析<code>multipart/form-data</code>信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">function parsePostDeep(req,fnCb)&#123;</div><div class="line">    var post=&#123;&#125;;</div><div class="line">    var files=&#123;&#125;;</div><div class="line"></div><div class="line">    //multipart/form-data; boundary=----WebKitFormBoundaryqFAIe2bYb7F35kSq</div><div class="line">    //console.log(req.headers[&apos;content-type&apos;]);</div><div class="line">    if(req.headers[&apos;content-type&apos;])&#123;</div><div class="line">        var mime=req.headers[&apos;content-type&apos;].split(&apos;; &apos;)[0];</div><div class="line">        var boundaryInfo=req.headers[&apos;content-type&apos;].split(&apos;; &apos;)[1];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    var arr=[];</div><div class="line">    req.on(&apos;data&apos;,function(s)&#123;</div><div class="line">        arr.push(s);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    req.on(&apos;end&apos;,function()&#123;</div><div class="line">        var buffer=Buffer.concat(arr);</div><div class="line">        //console.log(buffer.toString());</div><div class="line">        if(mime==&apos;multipart/form-data&apos;)&#123;</div><div class="line">            //文件型</div><div class="line">            var boundary=&apos;--&apos;+boundaryInfo.split(&apos;=&apos;)[1];</div><div class="line">            //切</div><div class="line">            var arrBuffer=bufferSplit(buffer,boundary);</div><div class="line"></div><div class="line">            //删除首尾</div><div class="line">            arrBuffer.pop();</div><div class="line">            arrBuffer.shift();</div><div class="line"></div><div class="line">            //去除数组中的每个首尾换行 -&gt; \r\n</div><div class="line">            for(var i=0; i&lt;arrBuffer.length; i++)&#123;</div><div class="line">                arrBuffer[i]=arrBuffer[i].slice(2,arrBuffer[i].length-2);</div><div class="line">            &#125;</div><div class="line">            //用两个换行切每个buffer</div><div class="line">            for(var i=0; i&lt;arrBuffer.length; i++)&#123;</div><div class="line">                var arrBufferInfo=bufferSplit(arrBuffer[i],&apos;\r\n\r\n&apos;);</div><div class="line"></div><div class="line">                //内容</div><div class="line">                var content=arrBufferInfo[1];</div><div class="line">                //其他相关信息 name filename filetype</div><div class="line">                //区分开file和post字段</div><div class="line">                if(arrBufferInfo[0].indexOf(&apos;\r\n&apos;)!=-1)&#123;</div><div class="line">                    //files</div><div class="line">                    var arrFilesInfo=bufferSplit(arrBufferInfo[0],&apos;\r\n&apos;);</div><div class="line">                    var name=querystring.parse(arrFilesInfo[0].toString(),&apos;; &apos;).name;</div><div class="line">                    name=name.substring(1,name.length-1);</div><div class="line">                    var filename=querystring.parse(arrFilesInfo[0].toString(),&apos;; &apos;).filename;</div><div class="line">                    filename=filename.substring(1,filename.length-1);</div><div class="line"></div><div class="line">                    var filetype=arrFilesInfo[1].toString().split(&apos;: &apos;)[1];</div><div class="line"></div><div class="line">                    //console.log(name,filename,filetype);</div><div class="line"></div><div class="line">                    files[name]=&#123;</div><div class="line">                        filename:filename,</div><div class="line">                        filetype:filetype,</div><div class="line">                        content:content</div><div class="line">                    &#125;;</div><div class="line">                &#125;else&#123;</div><div class="line">                    //普通</div><div class="line">                    var name=querystring.parse(arrBufferInfo[0].toString(),&apos;; &apos;).name;</div><div class="line">                    name=name.substring(1,name.length-1);</div><div class="line"></div><div class="line">                    post[name]=content.toString();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">            //console.log(arrBuffer.toString());</div><div class="line">        &#125;else&#123;</div><div class="line">            //普通post数据</div><div class="line">            post=querystring.parse(buffer.toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fnCb &amp;&amp; fnCb(post,files);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="buffer切割方法（上个方法里面有用到）"><a href="#buffer切割方法（上个方法里面有用到）" class="headerlink" title="buffer切割方法（上个方法里面有用到）"></a>buffer切割方法（上个方法里面有用到）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function bufferSplit(buffer,spliter)&#123;</div><div class="line">    var b=new Buffer(spliter);</div><div class="line">    var arr=[];</div><div class="line">    var start=0;</div><div class="line">    var index=0;</div><div class="line">    while((index=buffer.indexOf(b,start))!=-1)&#123;</div><div class="line">        arr.push(buffer.slice(start,index));</div><div class="line">        start=index+b.length;</div><div class="line">    &#125;</div><div class="line">    arr.push(buffer.slice(start));</div><div class="line">    return arr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终得到post数据信息</p>
<blockquote>
<p>下一篇介绍 post解析<code>multipart/form-data</code>数据的插件使用。</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/my.jpg"
               alt="Mr.Shen" />
          <p class="site-author-name" itemprop="name">Mr.Shen</p>
          <p class="site-description motion-element" itemprop="description">彩笔前端爬坑历程</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">32</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cuteshen" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Shen</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"cuteshen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="//cdn.jsdelivr.net/ua-parser.js/0.7.10/ua-parser.min.js"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

</body>
</html>
